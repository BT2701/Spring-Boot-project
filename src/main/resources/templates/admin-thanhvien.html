<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý thành viên</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/QuanLyThanhVien.css">
</head>

<body>

  <div class="container">
    <h1 class="mt-4 mb-4 text-center">Quản Lý Thành Viên</h1>
    <div class="row mb-3">
      <div class="col-md-6 offset-md-3">
        <form class="input-group" method="get" th:action="@{/thanh-vien-admin}">
          <input type="text" name="keyword" class="form-control" placeholder="Tìm kiếm theo họ tên">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
          </div>
        </form>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-6 offset-md-3 text-center">
        <button class="btn btn-success base-btn" data-bs-toggle="modal" data-bs-target="#modalChonCachThem" onclick=""><i
            class="fas fa-plus"></i>Thêm thành viên</button>
        <button class="btn btn-danger base-btn" data-bs-toggle="modal" data-bs-target="#modalXoaNhieu" onclick=""><i
            class="fa-solid fa-trash"></i>Xóa nhiều thành viên</button>
      </div>
    </div>

    <div class="member-container mt-5 w-100" style="overflow-x: hidden;">
      <div class="row member-container-header border-bottom border-dark ">
        <div class="col">
          <p class="fw-bold">Mã TV</p>
        </div>
        <div class="col">
          <p class="fw-bold">Họ và Tên</p>
        </div>
        <div class="col">
          <p class="fw-bold">Khoa</p>
        </div>
        <div class="col">
          <p class="fw-bold">Ngành</p>
        </div>
        <div class="col">
          <p class="fw-bold">Số điện thoại</p>
        </div>
        <div class="col">
          <p class="fw-bold">Thao tác</p>
        </div>
      </div>

      <div th:each="thanhVien : ${tvList}" class="row member-container-body" id="member-container-body">
        <div class="member pt-1 pb-1 border-bottom  d-flex justify-content-center">
          <div class="col">
            <p class="mb-0 text-center" th:text="${thanhVien.maTV}" id="mathanhvien"></p>
          </div>
          <div class="col">
            <p class="mb-0 text-center" th:text="${thanhVien.hoTen}"></p>
          </div>
          <div class="col">
            <p class="mb-0 text-center" th:text="${thanhVien.khoa}"></p>
          </div>
          <div class="col">
            <p class="mb-0 text-center" th:text="${thanhVien.nganh}"></p>
          </div>
          <div class="col text-center">
            <p class="mb-0" th:text="${thanhVien.sdt}"></p>
          </div>
          <div class="col text-center">
            <!-- Nút để xóa thành viên -->
            <button th:onclick="'ClickDeleteOneTVBtn(' + ${thanhVien.maTV} + ')'" class="btn" data-bs-toggle="modal" data-bs-target="#exampleModal"><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Xóa thành viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Bạn có muốn xóa thành viên với id : <span id="modal-body-idTV">0</span> không ?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button class="btn btn-primary" th:onclick="DeleteOneTv()" id="deleteTvBtn">Xóa</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="rightclicked"
      style="background-color: rgb(200, 200, 200);z-index: 100000;height: auto; position: absolute; display: none;">
      <div class="btn-group-vertical">
        <button id="openModalUpdateTVBtn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSua">
          Sửa thông tin
        </button>
        <button id="openModalJoinKVHTBtn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalKhuVucHocTap">
          Khu vực học tập
        </button>
        <button id="openModalCanhBaoViPhamBtn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCanhBaoViPham">
          Cảnh báo vi phạm
        </button>
        <button id="openModalMuonTraTbBtn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalMuonTra">
          Mượn trả
        </button>
        <button id="openModalDetailTVBtn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalXemChiTiet">
          Xem chi tiết
        </button>
      </div>
    </div>
  </div>

  <!-- Modal sưa-->
  <div class="modal fade" id="modalThemThanhVien" tabindex="-1" aria-labelledby="exampleModalLabel1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel1">Thêm Thành Viên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-2">
              <label for="inputMTV1" class="form-label">Mã thành viên</label>
              <input type="number" class="form-control" id="inputMTV1" disabled>
            </div>
            <div class="mb-2">
              <label for="inputHVT1" class="form-label">Họ và tên</label>
              <input type="text" class="form-control" id="inputHVT1">
            </div>
            <div class="mb-2">
              <label for="selectKhoa1" class="form-label">Khoa</label>
              <select class="form-select s_faculty" id="selectKhoa1" onchange="updateMajor()">
                <option value="CNTT">Khoa Công nghệ Thông tin</option>
                <option value="GD">Khoa Giáo dục</option>
                <option value="GDMN">Khoa Giáo dục Mầm non</option>
                <option value="KL">Khoa Luật</option>
              </select>
            </div>
            <div class="mb-2">
              <label for="major1" class="form-label">Ngành</label>
              <select class="form-select s_major" id="major1">
                <!-- Options will be populated dynamically based on faculty selection -->
              </select>
            </div>
            <div class="mb-2">
              <label for="inputSdt1" class="form-label">Số điện thoại</label>
              <input type="number" class="form-control" id="inputSdt1">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalAddTVBtn">Hủy</button>
          <button type="button" class="btn btn-primary" th:onclick="saveNewThanhVien()">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal sưa-->
  <div class="modal fade" id="modalSua" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel2">Cập Nhật Thông Tin Thành Viên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-2">
              <label for="inputMTV2" class="form-label">Mã thành viên</label>
              <input type="number" readonly class="form-control" id="inputMTV2">

            </div>
            <div class="mb-2">
              <label for="inputHVT2" class="form-label">Họ và tên</label>
              <input type="text" class="form-control" id="inputHVT2">
<!--              <div class="error">-->
<!--                <i class="fa-solid fa-circle-exclamation" style="color: #ff0000;"></i>-->
<!--                <span class="error-message">Trường hợp có lỗi</span>-->
<!--            </div>-->
            </div>
            <div class="mb-2">
              <label for="selectKhoa2" class="form-label">Khoa</label>
              <select class="form-select s_faculty" id="selectKhoa2" onchange="updateMajor()">
                <option value="CNTT">Khoa Công nghệ Thông tin</option>
                <option value="GD">Khoa Giáo dục</option>
                <option value="GDMN">Khoa Giáo dục Mầm non</option>
                <option value="KL">Khoa Luật</option>
              </select>
            </div>
            <div class="mb-2">
              <label for="major2" class="form-label">Ngành</label>
              <select class="form-select s_major" id="major2">
                <!-- Options will be populated dynamically based on faculty selection -->
              </select>
            </div>
            <div class="mb-2">
              <label for="inputSdt2" class="form-label">Số điện thoại</label>
              <input type="number" class="form-control" id="inputSdt2">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalUpdateTVBtn">Hủy</button>
          <button type="button" class="btn btn-primary" id="updateTVBtn">Lưu</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal delete mutiple-->
  <div class="modal fade" id="modalXoaNhieu" tabindex="-1" aria-labelledby="exampleModalLabel3" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel3">Xóa Nhiều Thành Viên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-2">
              <label for="selectKhoaThu" class="form-label">Khóa thứ</label>
              <select class="form-select" id="selectKhoaThu" name="KhoaThu">
                <option value=""></option>
                <option value="21">K21</option>
                <option value="22">K22</option>
                <option value="23">K23</option>
                <option value="24">K24</option>
              </select>
            </div>
            <div class="mb-2">
              <label for="inputHVT3" class="form-label">Họ và tên</label>
              <input type="text" class="form-control" id="inputHVT3">
            </div>
            <div class="mb-2">
              <label for="selectKhoa3" class="form-label">Khoa</label>
              <select class="form-select s_faculty" id="selectKhoa3" name="Khoa" onchange="updateMajor()">
                <option value=""></option>
                <option value="CNTT">Khoa Công nghệ Thông tin</option>
                <option value="GD">Khoa Giáo dục</option>
                <option value="GDMN">Khoa Giáo dục Mầm non</option>
                <option value="KL">Khoa Luật</option>
              </select>
            </div>
            <div class="mb-2">
              <label for="selectNganh3" class="form-label">Ngành</label>
              <select class="form-select s_major" id="selectNganh3" name="Nganh">
                <option value=""></option>
                <!-- Options will be populated dynamically based on faculty selection -->
              </select>
            </div>
            <div class="mb-2">
              <label for="inputSdt3" class="form-label">Số điện thoại</label>
              <input type="number" class="form-control" id="inputSdt3">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeDeleteManyTvModalBtn">Hủy</button>
          <button type="button" class="btn btn-primary" id="deleteManyTvBtn">Xóa</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal Khu Vuc Hoc Tap-->
  <div class="modal fade" id="modalKhuVucHocTap" tabindex="-1" aria-labelledby="exampleModalLabel4" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel4">Khu Vực Học Tập</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-2">
              <label for="inputMaTV4" class="form-label">Mã thành viên</label>
              <input type="text" class="form-control" id="inputMaTV4" disabled>
<!--              <div class="error">-->
<!--                <i class="fa-solid fa-circle-exclamation" style="color: #ff0000;"></i>-->
<!--                <span class="error-message">Trường hợp có lỗi</span>-->
<!--            </div>-->
            </div>
            <div class="mb-2">
              <label for="inputHVT4" class="form-label">Họ và tên</label>
              <input type="text" class="form-control" id="inputHVT4" disabled>
            </div>
            <div class="mb-2">
              <label for="inputKhoa4" class="form-label">Khoa</label>
              <input type="text" class="form-control" id="inputKhoa4" disabled>
            </div>
            <div class="mb-2">
              <label for="inputNganh4" class="form-label">Ngành</label>
              <input type="text" class="form-control" id="inputNganh4" disabled>
            </div>
            <div class="mb-2">
              <label for="inputSdt4" class="form-label">Số điện thoại</label>
              <input type="text" class="form-control" id="inputSdt4" disabled>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalJoinKvhtTVBtn">Hủy</button>
          <button type="button" class="btn btn-primary" id="joinKVHTBtn">Vào</button>
        </div>
      </div>
    </div>
  </div>



  <!-- Modal canh bao vi pham-->
  <div class="modal fade" id="modalCanhBaoViPham" tabindex="-1" aria-labelledby="exampleModalLabel5" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel5">Cảnh Báo Vi Phạm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-2">
              <label for="selectThanhVien5" class="form-label">Thành viên</label>
              <select class="form-select" id="selectThanhVien5" name="ThanhVien">
                <option th:each="thanhVien : ${tvList}"
                        th:value="${thanhVien.maTV + '-' + thanhVien.hoTen}"
                        th:text="${thanhVien.maTV + '-' + thanhVien.hoTen}"></option>
              </select>
            </div>
            <div class="mb-2">
              <label for="inputViPham5" class="form-label">Vi phạm</label>
              <input type="text" class="form-control" id="inputViPham5">
            </div>
            <div class="mb-2">
              <label for="inputSoTien5" class="form-label">Số tiền</label>
              <input type="number" class="form-control" id="inputSoTien5">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalCbcpBtn">Hủy</button>
          <button type="button" class="btn btn-primary" id="addViPhamBtn">Lưu</button>
        </div>
      </div>
    </div>
  </div>



  <!-- Modal mượn trả-->
  <div class="modal fade" id="modalMuonTra" tabindex="-1" aria-labelledby="exampleModalLabel6" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel6">Mượn Trả Thiết Bị</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-2" th:if="${tvList != null}">
              <label for="selectThanhVien6" class="form-label">Thành viên</label>
              <select class="form-select" id="selectThanhVien6" name="ThanhVien">
                <option th:each="thanhVien : ${tvList}"
                        th:value="${thanhVien.maTV + '-' + thanhVien.hoTen}"
                        th:text="${thanhVien.maTV + '-' + thanhVien.hoTen}"></option>
              </select>
            </div>

            <div class="mb-2" th:if="${tbList != null}">
              <label for="selectThietBi6" class="form-label">Thiết bị</label>
              <select class="form-select" id="selectThietBi6" name="ThietBi">
                <option th:each="thietbi : ${tbList}"
                        th:value="${thietbi.maTB + '-' + thietbi.tenTB}"
                        th:text="${thietbi.maTB + '-' + thietbi.tenTB}"></option>
              </select>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalMuonTraTbBtn">Hủy</button>
          <button type="button" class="btn btn-primary" id="muonThietBiBtn">Mượn</button>
          <button type="button" class="btn btn-primary" id="traThietBiBtn">Trả</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal xem chi tiet-->
  <div class="modal fade" id="modalXemChiTiet" tabindex="-1" aria-labelledby="exampleModalLabel7" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel7">Xem Chi Tiết Thành Viên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-2">
              <label for="inputMTV7" class="form-label">Mã thành viên</label>
              <input type="text" readonly class="form-control" id="inputMTV7">
            </div>
            <div class="mb-2">
              <label for="inputHVT7" class="form-label">Họ và tên</label>
              <input type="text" readonly class="form-control" id="inputHVT7">
            </div>
            <div class="mb-2">
              <label for="inputSdt7" class="form-label">Số điện thoại</label>
              <input type="text" readonly class="form-control" id="inputSdt7">
            </div>
            <div class="mb-2">
              <label for="inputNganh7" class="form-label">Ngành</label>
              <input type="text" readonly class="form-control" id="inputNganh7">
            </div>
            <div class="mb-2">
              <label for="inputKhoa7" class="form-label">Khoa</label>
              <input type="text" readonly class="form-control" id="inputKhoa7">
            </div>
            <div class="mb-2">
              <label for="inputEmail7" class="form-label">Email</label>
              <input type="text" readonly class="form-control" id="inputEmail7">
            </div>

            <div class="mb-2">
              <label for="inputPw7" class="form-label">Password</label>
              <input type="text" readonly class="form-control" id="inputPw7">
            </div>

            <div class="mb-2">
              <label for="inputTbdm7" class="form-label">Thiết bị đã mượn</label>
              <input type="text" readonly class="form-control" id="inputTbdm7">
            </div>

            <div class="mb-2">
              <label for="inputVp7" class="form-label">Vi phạm</label>
              <input type="text" readonly class="form-control" id="inputVp7">
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal lựa chọn cách thêm thành viên-->
  <div class="modal fade" id="modalChonCachThem" tabindex="-1" aria-labelledby="exampleModalLabel8" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel8">Cách thêm thành viên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <button id="addTVByFormBtn" class="btn btn-primary base-btn" data-bs-toggle="modal" data-bs-target="#modalThemThanhVien"
            data-bs-dismiss="modal"><i class="fas fa-plus"></i>Thông qua form</button>
          <button class="btn btn-success base-btn" data-bs-toggle="modal" data-bs-target="#modalChonFile"
            data-bs-dismiss="modal"><i class="fas fa-plus"></i>Thông qua file</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal thêm thành viên thông qua file-->
  <div class="modal fade" id="modalChonFile" tabindex="-1" aria-labelledby="exampleModalLabel9" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel9">Thêm Thành Viên</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body ">
          <div class="mb-2">
            <label for="filechooser" class="form-label">Chọn file</label>
            <input type="file" class="form-control" id="filechooser" accept=".xls, .xlsx">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalUploadFile">Đóng</button>
          <button type="button" class="btn btn-primary" id="uploadFileBtn">Tải lên</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script>
    var maThanhVienBackUp = -1;

    // xóa thành viên
    var maTvToDelete = -1;
    function ClickDeleteOneTVBtn (matv) {
      document.getElementById("modal-body-idTV").innerText = matv.toString();

      maTvToDelete = matv;
    }
    async function DeleteOneTv() {
      if(maTvToDelete == -1) return;

      const data = { maTV: maTvToDelete };

      try {
          const response = await fetch("/thanhvien/delete/" + maTvToDelete, {
              method: "DELETE",
              headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams(data),
          });

          if (response.ok) {
              document.getElementById("closeModalJoinKvhtTVBtn").click();
              window.location.reload();
          } else {
              const errorMessage = await response.text();
              alert(errorMessage);
              document.getElementById("closeModalJoinKvhtTVBtn").click();
          }
      } catch (error) {
          console.error("Lỗi:", error);
          alert("Đã xảy ra lỗi khi thực hiện yêu cầu. Vui lòng thử lại sau.");
      }
    }

    // xử lý click phải hiện ra modal
    document.body.addEventListener('click', function () {
      document.getElementById("rightclicked").style.display = "none";
    })
    document.body.addEventListener('contextmenu', function () {
      document.getElementById("rightclicked").style.display = "none";
    })

    members = document.querySelectorAll('.member');
    members.forEach(member => {
      member.addEventListener('contextmenu', function (ev) {
      ev.stopPropagation();
      ev.preventDefault();

      const parentElement = ev.target.closest('.member'); // Tìm phần tử cha gần nhất với class 'member'
      const maTVElement = parentElement.querySelector("#mathanhvien"); // Tìm phần tử con với ID 'mathanhvien'

      maThanhVienBackUp = maTVElement.innerText || -1;

      rightclick();
      return false;
    }, false);
    });

    function rightclick() {
      var e = window.event;
      var cantThinkOfAName = document.getElementById("rightclicked");
      cantThinkOfAName.style.display = "block";
      cantThinkOfAName.style.left = e.clientX + "px";
      cantThinkOfAName.style.top = e.clientY + "px";
    }

    // render ra các major trong các modal
    function renderMajorFirstTime() {
      const facultySelects = document.querySelectorAll(".s_faculty");
      const majorSelects = document.querySelectorAll(".s_major");

      const majors = ["Khoa học máy tính", "Truyền thông dữ liệu và mạng máy tính", "Công nghệ phần mềm", "Kỹ thuật máy tính", "Kỹ thuật mạng"];

      facultySelects.forEach((facultySelect, index) => {
          const majorSelect = majorSelects[index];

          if (facultySelect.value === "CNTT") {
              majorSelect.innerHTML = "";

             majors.forEach(major => {
                  const option = document.createElement("option");
                  option.text = major;
                  option.value = major;
                  majorSelect.add(option);
              });
         }
      });
    }
    renderMajorFirstTime();

    function updateMajor() {
            const facultySelects = document.querySelectorAll(".s_faculty");
            const majorSelects = document.querySelectorAll(".s_major");

            facultySelects.forEach((facultySelect, index) => {
                const majorSelect = majorSelects[index];
                majorSelect.innerHTML = "";

                if (facultySelect.value === "CNTT") {
                    const majors = ["Khoa học máy tính", "Truyền thông dữ liệu và mạng máy tính", "Công nghệ phần mềm", "Kỹ thuật máy tính", "Kỹ thuật mạng"];
                    majors.forEach(major => {
                        const option = document.createElement("option");
                        option.text = major;
                        option.value = major;
                        majorSelect.add(option);
                    });
                } else if (facultySelect.value === "GD") {
                    const majors = ["Tư vấn học đường", "Tâm lý giáo dục", "Sư phạm", "Công nghệ giáo dục"];
                    majors.forEach(major => {
                        const option = document.createElement("option");
                        option.text = major;
                        option.value = major;
                        majorSelect.add(option);
                    });
                } else if (facultySelect.value === "GDMN") {
                    const majors = ["Ngành giáo dục mầm non"];
                    majors.forEach(major => {
                        const option = document.createElement("option");
                        option.text = major;
                        option.value = major;
                        majorSelect.add(option);
                    });
                } else if (facultySelect.value === "KL") {
                    const majors = ["Luật Hình sự", "Luật Dân sự", "Luật Hành chính","Luật Thương mại","Luật Quốc tế","Cố vấn pháp lý","Thẩm phán"];
                    majors.forEach(major => {
                        const option = document.createElement("option");
                        option.text = major;
                        option.value = major;
                        majorSelect.add(option);
                    });
                }
            });
        }

    function validateAddAndUpdateThanhVien(maTV, hoten, khoa, nganh, sdt) {
        if (!maTV || !hoten || !khoa || !nganh || !sdt) {
            alert("Tất cả các trường phải được điền.");
            return false;
        }

        if (sdt.length !== 10) {
            alert("Số điện thoại phải là 10 chữ số.");
            return false;
        }

        return true;
    }

    document.getElementById("addTVByFormBtn").addEventListener("click", async () => {
        const inputMaTV = document.getElementById("inputMTV1");

        // 2 số đầu tiên
        const firstNumber = "11";
        // Lấy năm hiện tại
        const currentDate = new Date();
        const year = currentDate.getFullYear();
        // Lấy 2 số cuối cùng của năm
        const yearStr = String(year);
        const majorStr = yearStr.substring(2, 4);

        // Lấy 6 số cuối cùng của maTV
        const res = await fetch("/thanh-vien/getAll");
        const data = await res.json();
        console.log(data);
        const lastThanhVien = data.length !== 0 && data[data.length - 1];
        const maTVStr = lastThanhVien && (lastThanhVien.maTV + 1);
        const last6Digits = maTVStr.toString().slice(-6);

        const maTV = firstNumber + majorStr + last6Digits;
        inputMaTV.value = maTV;
    })

    function saveNewThanhVien() {
        const maTV = document.getElementById("inputMTV1").value.trim();
        const hoten = document.getElementById("inputHVT1").value.trim();
        const khoa = document.getElementById("selectKhoa1").value;
        const nganh = document.getElementById("major1").value;
        const sdt = document.getElementById("inputSdt1").value.trim();
        const email = "";
        const password = "";

        if (!validateAddAndUpdateThanhVien(maTV, hoten, khoa, nganh, sdt)) {
            return;
        }

        const data = {
            maTV,
            hoten,
            khoa,
            nganh,
            sdt,
            email,
            password
        };

        try {
          fetch("/thanhvien/add", {
              method: "POST",
              headers: {
                  "Content-Type": "application/x-www-form-urlencoded"
              },
              body: new URLSearchParams(data)
          })
          .then(response => {
              if (response.ok) {
                  document.getElementById("closeModalAddTVBtn").click();
                  window.location.reload();
              } else {
                  alert("Có lỗi khi thêm thành viên");
              }
          })
          .catch(error => console.error("Lỗi:", error));
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi thực hiện yêu cầu. Vui lòng thử lại sau.");
        }
    }

    document.getElementById("uploadFileBtn").addEventListener("click", function () {
        const fileInput = document.getElementById("filechooser");

        if (fileInput.files.length === 0) { // Kiểm tra nếu không có file được chọn
            alert("Vui lòng chọn một file Excel để tải lên.");
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);

        fetch("/upload-excel", {
            method: "POST",
            body: formData
        })
        .then(response => {
            if (response.ok) {
                document.getElementById("closeModalUploadFile").click();
                window.location.reload();
            } else {
                return response.text().then(text => {
                    alert("Lỗi tải lên: " + text);
                });
            }
        })
        .catch(error => {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi tải lên. Vui lòng thử lại sau.");
        });
    });

    var emailBackupToUpdate = "";
    var passwordBackupToUpdate = "";
    document.getElementById("openModalUpdateTVBtn").addEventListener("click", async () => {
        if(maThanhVienBackUp === -1) {
          alert("Không tìm thấy sinh viên với mã : " + maThanhVienBackUp)
        };
    
        const inputMaTV = document.getElementById("inputMTV2");
        const inputHoten = document.getElementById("inputHVT2");
        const inputKhoa = document.getElementById("selectKhoa2");
        const inputSdt = document.getElementById("inputSdt2");

        const res = await fetch("/thanhvien/" + maThanhVienBackUp);
        const tvJson = await res.json();
        const tv = tvJson.thanhVien;

        inputMaTV.value = maThanhVienBackUp;
        inputHoten.value = tv.hoTen;
        inputSdt.value = tv.sdt;
        emailBackupToUpdate = tv.email;
        passwordBackupToUpdate = tv.password;

        for (let i = 0; i < inputKhoa.options.length; i++) {
          if (inputKhoa.options[i].value === tv.khoa) {
            inputKhoa.selectedIndex = i;
            updateMajor();

            const inputNganh = document.getElementById("major2");
            for (let i = 0; i < inputNganh.options.length; i++) {
              if (inputNganh.options[i].value === tv.nganh) {
                inputNganh.selectedIndex = i;
                break;
              }
            }

            break;
          }
        }

    });

    document.getElementById("updateTVBtn").addEventListener("click", () => {
      const maTV = document.getElementById("inputMTV2").value.trim();
      const hoten = document.getElementById("inputHVT2").value.trim();
      const khoa = document.getElementById("selectKhoa2").value.trim();
      const nganh = document.getElementById("major2").value.trim();
      const sdt = document.getElementById("inputSdt2").value.trim();
      const email = emailBackupToUpdate;
      const password = passwordBackupToUpdate;

      if (!validateAddAndUpdateThanhVien(maTV, hoten, khoa, nganh, sdt)) {
          return;
      }

      const data = {
        maTV,
        hoten,
        khoa,
        nganh,
        sdt,
        email,
        password,
      };

      try {
        fetch("/thanhvien/update", {
          method: "PUT",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams(data),
         })
          .then((response) => {
            if (response.ok) {
              document.getElementById("closeModalUpdateTVBtn").click();
              window.location.reload();
            } else {
              alert("Có lỗi khi sửa thông tin thành viên.");
            }
          })
          .catch((error) => {
            console.error("Lỗi:", error);
          });
      } catch (error) {
          console.error("Lỗi:", error);
          alert("Đã xảy ra lỗi khi thực hiện yêu cầu. Vui lòng thử lại sau.");
      }

    })

    // xem chi tiết
    document.getElementById("openModalDetailTVBtn").addEventListener("click", async () => {
      if(maThanhVienBackUp === -1) {
          alert("Không tìm thấy sinh viên với mã : " + maThanhVienBackUp)
      };
    
      const res = await fetch("/thanhvien/" + maThanhVienBackUp);
      const tvJson = await res.json();
      const tv = tvJson.thanhVien;
      const vipham = tvJson.viPham || "";
      const thietBiDaMuon = tvJson.thietBiDaMuon || "";

      if(tv === null) {
        return;
      }

      document.getElementById("inputMTV7").value = tv.maTV;
      document.getElementById("inputHVT7").value = tv.hoTen;
      document.getElementById("inputNganh7").value = tv.nganh;
      document.getElementById("inputKhoa7").value = tv.khoa;
      document.getElementById("inputSdt7").value = tv.sdt;
      document.getElementById("inputEmail7").value = tv.email;
      document.getElementById("inputPw7").value = tv.password;
      document.getElementById("inputTbdm7").value = thietBiDaMuon;
      document.getElementById("inputVp7").value = vipham;
    })


    // vào khu vực học 
    document.getElementById("openModalJoinKVHTBtn").addEventListener("click", async () => {
      if(maThanhVienBackUp === -1) {
          alert("Không tìm thấy sinh viên với mã : " + maThanhVienBackUp)
      };
    
      const res = await fetch("/thanhvien/" + maThanhVienBackUp);
      const tvJson = await res.json();
      const tv = tvJson.thanhVien;

      if(tv === null) {
        return;
      }

      document.getElementById("inputMaTV4").value = tv.maTV;
      document.getElementById("inputHVT4").value = tv.hoTen;
      document.getElementById("inputNganh4").value = tv.nganh;
      document.getElementById("inputKhoa4").value = tv.khoa;
      document.getElementById("inputSdt4").value = tv.sdt;
    })

    document.getElementById("joinKVHTBtn").addEventListener("click", async () => {
      const maTV = document.getElementById("inputMaTV4").value;

      const data = { maTV };

      try {
          const response = await fetch("/thanhvien/join-kvht", {
              method: "POST",
              headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams(data),
          });

          if (response.ok) {
              document.getElementById("closeModalJoinKvhtTVBtn").click();
              window.location.reload();
          } else {
              const errorMessage = await response.text();
              alert(errorMessage);
          }
      } catch (error) {
          console.error("Lỗi:", error);
          alert("Đã xảy ra lỗi khi thực hiện yêu cầu. Vui lòng thử lại sau.");
      }
    })


    // cảnh báo vi phạm
    document.getElementById("openModalCanhBaoViPhamBtn").addEventListener("click", async () => {
      if(maThanhVienBackUp === -1) {
          alert("Không tìm thấy sinh viên với mã : " + maThanhVienBackUp)
      };

      const res = await fetch("/thanhvien/" + maThanhVienBackUp);
      const tvJson = await res.json();
      const tv = tvJson.thanhVien;

      document.getElementById("selectThanhVien5").value = maThanhVienBackUp + "-" + tv.hoTen;
    })

    document.getElementById("addViPhamBtn").addEventListener("click", async () => {
      const viPham = document.getElementById("inputViPham5").value.trim();
      const soTienRaw = document.getElementById("inputSoTien5").value.trim();

      const info = document.getElementById("selectThanhVien5").value.trim();
      const maTV = parseInt(info.split("-")[0]);
      const hoTen = info.split("-")[1];

      if (viPham.length === 0) {
        alert("Trường vi phạm không được bỏ trống!");
        return;
      }

      let soTien = -1;

       if (soTienRaw.length !== 0) {
          const soTienParsed = parseInt(soTienRaw);
          if (soTienParsed <= 0) {
            alert("Số tiền phải là số dương!");
            return;
          }
          soTien = soTienParsed;
       }

      const data = {
        maTV,
        viPham,
        soTien,
      };

      try {
        const response = await fetch("/thanhvien/cbvp", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams(data),
        });

        if (response.ok) {
          document.getElementById("closeModalCbcpBtn").click();
          window.location.reload();
        } else {
          const errorMessage = await response.text();
          alert(errorMessage);
        }
      } catch (error) {
        console.error("Lỗi:", error);
        alert("Đã xảy ra lỗi khi thực hiện yêu cầu. Vui lòng thử lại sau.");
      }
    });



    // mượn trả thiết bị  id="openModalMuonTraTbBtn"  id="muonThietBiBtn" id="traThietBiBtn" id="closeModalMuonTraTbBtn"
    document.getElementById("openModalMuonTraTbBtn").addEventListener("click", async () => {
      if(maThanhVienBackUp === -1) {
          alert("Không tìm thấy sinh viên với mã : " + maThanhVienBackUp)
      };

      const res = await fetch("/thanhvien/" + maThanhVienBackUp);
      const tvJson = await res.json();
      const tv = tvJson.thanhVien;
      document.getElementById("selectThanhVien6").value = maThanhVienBackUp + "-" + tv.hoTen;
    })

    document.getElementById("muonThietBiBtn").addEventListener("click", async () => {
      const tvInfo = document.getElementById("selectThanhVien6").value.trim();
      const maTV = parseInt(tvInfo.split("-")[0]);

      const tbInfo = document.getElementById("selectThietBi6").value.trim();
      const maTB = parseInt(tbInfo.split("-")[0]);

      const data = {
        maTV,
        maTB
      };

      try {
        const response = await fetch("/thanhvien/muontb", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams(data),
        });

        if (response.ok) {
          document.getElementById("closeModalMuonTraTbBtn").click();
          window.location.reload();
        } else {
          const errorMessage = await response.text();
          console.log(errorMessage);
          alert(errorMessage);
        }
      } catch (error) {
        console.error("Lỗi:", error);
        alert("Đã xảy ra lỗi khi thực hiện yêu cầu. Vui lòng thử lại sau.");
      }
    })

    document.getElementById("traThietBiBtn").addEventListener("click", async () => {
      const tvInfo = document.getElementById("selectThanhVien6").value.trim();
      const maTV = parseInt(tvInfo.split("-")[0]);

      const tbInfo = document.getElementById("selectThietBi6").value.trim();
      const maTB = parseInt(tbInfo.split("-")[0]);

      const data = {
        maTV,
        maTB
      };

      try {
        const response = await fetch("/thanhvien/tratb", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams(data),
        });

        if (response.ok) {
          document.getElementById("closeModalMuonTraTbBtn").click();
          window.location.reload();
        } else {
          const errorMessage = await response.text();
          alert(errorMessage);
        }
      } catch (error) {
        console.error("Lỗi:", error);
        alert("Đã xảy ra lỗi khi thực hiện yêu cầu. Vui lòng thử lại sau.");
      }
    })


    // xóa nhiều thành viên
    document.getElementById("deleteManyTvBtn").addEventListener("click", () => {
        const khoaThu = document.getElementById("selectKhoaThu").value; // ko co = ""
        const hoTen = document.getElementById("inputHVT3").value.trim();
        const khoa = document.getElementById("selectKhoa3").value; // ko co = ""
        const nganh = document.getElementById("selectNganh3").value; // ko co = ""
        const sdt = document.getElementById("inputSdt3").value.trim();

        if(khoaThu.trim().length === 0 && hoTen.trim().length === 0 && khoa.trim().length === 0
          && nganh.trim().length === 0 && sdt.trim().length === 0
        ) {
          alert("Hãy nhập hoặc chọn 1 điều kiện để thực hiện xóa nhiều !");
          return;
        }

        const data = {
            khoaThu: khoaThu.length > 0 ? khoaThu : undefined,
            hoTen: hoTen.length > 0 ? hoTen : undefined,
            khoa: khoa.length > 0 ? khoa : undefined,
            nganh: nganh.length > 0 ? nganh : undefined,
            sdt: sdt.length > 0 ? sdt : undefined
        };

        fetch("/thanhvien/delete-multiple", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                document.getElementById("closeDeleteManyTvModalBtn").click();
                window.location.reload();
            } else {
                response.text().then(text => alert("Lỗi: " + text));
            }
        })
        .catch(error => {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi. Vui lòng thử lại sau.");
        });
    })
  </script>
</body>

</html>
